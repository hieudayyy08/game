<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Says - Tr√≤ ch∆°i Tr√≠ nh·ªõ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900;bold&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(var(--grid-size), 1fr);
            gap: 12px;
            width: 600px;
            max-width: 95vw;
            margin: auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            background-color: #374151;
            padding: 12px;
        }
        .pad {
            min-height: 100%;
            padding-top: 100%;
            position: relative;
            transition: all 0.15s ease-out;
            cursor: pointer;
            opacity: 0.8;
            border: 4px solid #374151;
            border-radius: 8px;
            user-select: none;
        }
        .pad.lit {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 15px 3px rgba(255, 255, 255, 0.5);
        }
        .no-click {
            pointer-events: none;
        }
        /* ·∫®n c√°c m√†n h√¨nh ban ƒë·∫ßu */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Modal (Game Over) */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #374151; /* N·ªÅn x√°m t·ªëi */
            color: white;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body>

    <!-- Wrapper ch·ª©a c√°c m√†n h√¨nh -->
    <div id="start-wrapper" class="w-full max-w-lg">
        
        <!-- M√†n h√¨nh 1: Nh·∫≠p T√™n -->
        <div id="name-screen" class="screen active w-full bg-gray-800 p-6 md:p-10 rounded-xl shadow-2xl text-center transition duration-500">
            <h2 class="text-4xl font-black text-white mb-4">SIMON SAYS</h2>
            <h3 class="text-xl font-semibold text-indigo-400 mb-6">Tr√≤ ch∆°i Tr√≠ nh·ªõ Th·ªùi gian Th·ª±c</h3>
            
            <div id="firebase-status-box" class="p-3 mb-6 rounded-lg text-sm font-medium transition duration-300 bg-yellow-900 text-yellow-300 border border-yellow-700">
                Tr·∫°ng th√°i Firebase: ƒêang kh·ªüi t·∫°o...
            </div>

            <div class="mb-8 p-4 bg-gray-700 rounded-lg">
                <label for="player-name-input" class="block text-gray-300 font-medium mb-2 text-left">ƒê·∫∑t t√™n ng∆∞·ªùi ch∆°i:</label>
                <input type="text" id="player-name-input" maxlength="15" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n (2-15 k√Ω t·ª±)"
                       class="flex-grow p-3 rounded-lg bg-gray-600 text-white border border-gray-500 focus:ring-indigo-500 focus:border-indigo-500 w-full"
                       value="">
                <p id="current-player-name" class="mt-2 text-sm text-yellow-400 text-left overflow-x-auto break-all">ID ng∆∞·ªùi ch∆°i (UID): ƒêang t·∫£i...</p>
            </div>
            
            <button id="continue-button" disabled class="bg-indigo-600 text-white font-bold py-4 px-12 rounded-full text-xl transition duration-300 shadow-xl opacity-50 cursor-not-allowed">
                L∆ØU T√äN & TI·∫æP T·ª§C
            </button>
        </div>
        
        <!-- M√†n h√¨nh 2: Ch·ªçn ƒê·ªô Kh√≥ & Leaderboard -->
        <div id="difficulty-screen" class="screen w-full bg-gray-800 p-6 md:p-10 rounded-xl shadow-2xl text-center transition duration-500">
            <h2 class="text-3xl font-black text-white mb-4">CH·ªåN C·∫§P ƒê·ªò</h2>
            
            <div class="mb-6">
                <label for="difficulty-select" class="block text-gray-300 font-medium mb-2 text-left">Ch·ªçn C·∫•p ƒë·ªô:</label>
                <select id="difficulty-select" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="easy">D·ªÖ (4 m√†u, ch·∫≠m)</option>
                    <option value="medium">V·ª´a (9 m√†u, v·ª´a)</option>
                    <option value="hard" selected>Kh√≥ (16 m√†u, nhanh)</option>
                    <option value="superhard">Si√™u Kh√≥ (25 m√†u, r·∫•t nhanh)</option>
                </select>
            </div>

            <button id="play-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full text-xl transition duration-300 shadow-xl hover:scale-105">
                CH∆†I NGAY
            </button>
            <button id="change-name-button" class="block mx-auto mt-4 text-sm text-indigo-400 hover:text-indigo-300">
                ƒê·ªïi T√™n Ng∆∞·ªùi Ch∆°i
            </button>
            
            <div class="mt-8">
                <h4 class="text-2xl font-black text-yellow-400 mb-4 border-b pb-2 border-gray-600">B·∫¢NG X·∫æP H·∫†NG TOP 5</h4>
                <div id="leaderboard-container" class="text-gray-200">
                    <div class="flex justify-between font-extrabold border-b border-gray-600 pb-1 mb-2">
                        <span class="w-1/6 text-left">H·∫°ng</span>
                        <span class="w-3/6 text-left">T√™n</span>
                        <span class="w-2/6 text-right">ƒêi·ªÉm (C·∫•p)</span>
                    </div>
                    <ul id="leaderboard-list" class="space-y-1 text-sm">
                        <li class="text-center text-gray-400 py-4">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <!-- 2. V√πng Ch·ª©a Tr√≤ Ch∆°i (Game Container - ·∫®n) -->
    <div id="game-container" class="screen flex flex-col items-center justify-center p-6 md:p-10">
        
        <div class="p-4 bg-gray-800 rounded-xl shadow-lg w-full max-w-lg text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-4">Simon Says</h1>
            <div id="level-display" class="text-2xl font-bold text-gray-200 mb-2">C·∫•p ƒë·ªô: 1</div>
            <div id="status-display" class="text-base font-semibold text-yellow-400 mb-4 h-6">Nh·∫•n B·∫ÆT ƒê·∫¶U</div>
            <div class="flex flex-row justify-center space-x-4">
                <button id="game-start-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-xl">
                    B·∫ÆT ƒê·∫¶U
                </button>
                <button id="back-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                    </svg>
                    Quay l·∫°i
                </button>
            </div>
        </div>

        <div id="game-grid" class="game-board"></div>

        <div class="mt-4 p-4 bg-gray-800 rounded-xl shadow-lg w-full max-w-lg text-center">
            <p class="text-gray-300">M·ª•c ti√™u: L·∫∑p l·∫°i tr√¨nh t·ª± nh·∫•p nh√°y c·ªßa m√°y t√≠nh.</p>
            <p id="high-score-display" class="text-xl font-extrabold text-indigo-400 mt-2">ƒêi·ªÉm cao c√° nh√¢n: 0</p>
        </div>
    </div>

    <!-- 3. Modal Game Over (·∫®n ban ƒë·∫ßu) -->
    <div id="game-over-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="modal-title" class="text-4xl font-black text-center text-red-500 mb-4">GAME OVER</h2>
            <p id="modal-score" class="text-center text-2xl font-bold mb-1">B·∫°n ƒë·∫°t ƒë∆∞·ª£c: <span class="text-yellow-400">C·∫•p 0</span></p>
            <p id="modal-new-record" class="text-center text-lg font-semibold text-green-400 mb-6 hidden">üéâ K·ª∂ L·ª§C M·ªöI! üéâ</p>

            <div class="mt-4">
                <h4 class="text-xl font-bold text-yellow-400 mb-2 text-center border-b border-gray-500 pb-1">B·∫£ng X·∫øp H·∫°ng (<span id="modal-difficulty-name"></span>)</h4>
                <div id="modal-leaderboard-container" class="text-gray-200 max-h-48 overflow-y-auto">
                    <div class="flex justify-between font-extrabold border-b border-gray-600 pb-1 mb-2 sticky top-0 bg-gray-700 px-1">
                        <span class="w-1/6 text-left">H·∫°ng</span>
                        <span class="w-3/6 text-left">T√™n</span>
                        <span class="w-2/6 text-right">ƒêi·ªÉm (C·∫•p)</span>
                    </div>
                    <ul id="modal-leaderboard-list" class="space-y-1 text-sm px-1">
                        <!-- Modal Leaderboard items -->
                    </ul>
                </div>
            </div>

            <div class="mt-8 flex flex-col md:flex-row gap-4">
                <button id="retry-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg text-lg">
                    CH∆†I L·∫†I
                </button>
                <button id="menu-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg text-lg">
                    QUAY L·∫†I M√ÄN H√åNH CH√çNH
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE IMPORTS (T·ª™ CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // B·∫ÆT BU·ªòC: Th√™m Auth v√† Firestore
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDoc, runTransaction, setLogLevel, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- C·∫§U H√åNH FIREBASE M√Ä B·∫†N ƒê√É CUNG C·∫§P ---
        const firebaseConfig = {
          apiKey: "AIzaSyBtAocn4ppLW2f5Pq-szy2RUFqWYOxlXTQ",
          authDomain: "tingk-311ee.firebaseapp.com",
          projectId: "tingk-311ee",
          storageBucket: "tingk-311ee.firebasestorage.app",
          messagingSenderId: "273578835061",
          appId: "1:273578835061:web:007d66d6f992a5c47e8c3c",
          measurementId: "G-8SF1X408JV"
        };

        // --- BI·∫æN TO√ÄN C·ª§C (ƒê√£ s·ª≠a ƒë·ªïi) ---
        const appId = firebaseConfig.appId; // L·∫•y t·ª´ config c·ªßa b·∫°n
        const initialAuthToken = null; // B·∫ÆT BU·ªòC: Lu√¥n ƒëƒÉng nh·∫≠p ·∫©n danh
        
        let db;
        let auth;
        let userId = null;
        let isFirebaseEnabled = false; 
        let playerName = 'Ng∆∞·ªùi ch∆°i'; 
        let personalBestScores = {}; // L∆∞u ƒëi·ªÉm cao c√° nh√¢n cho m·ªói ƒë·ªô kh√≥

        // C·∫•u h√¨nh Kh√≥ khƒÉn
        const DIFFICULTIES = {
            'easy': { colors: 4, root: 2, speed: 450, name: 'D·ªÖ' }, 
            'medium': { colors: 9, root: 3, speed: 300, name: 'V·ª´a' }, 
            'hard': { colors: 16, root: 4, speed: 200, name: 'Kh√≥' }, 
            'superhard': { colors: 25, root: 5, speed: 120, name: 'Si√™u Kh√≥' } 
        };

        // ƒê·ªãnh nghƒ©a 25 m√†u
        const ALL_COLORS = {
            'green': ['#10b981', '#6ee7b7'], 'red': ['#ef4444', '#fca5a5'], 'yellow': ['#f59e0b', '#fcd34d'],
            'blue': ['#3b82f6', '#93c5fd'], 'purple': ['#8b5cf6', '#a78bfa'], 'cyan': ['#06b6d4', '#67e8f9'],
            'pink': ['#ec4899', '#f472b6'], 'lime': ['#84cc16', '#bef264'], 'orange': ['#f97316', '#fdba74'],
            'brown': ['#92400e', '#d1b4a1'], 'teal': ['#14b8a6', '#5eead4'], 'indigo': ['#4f46e5', '#818cf8'],
            'violet': ['#a855f7', '#c4b5fd'], 'fuchsia': ['#d946ef', '#f0abf7'], 'rose': ['#f43f5e', '#fda4af'],
            'emerald': ['#059669', '#34d399'], 'sky': ['#0ea5e9', '#7dd3fc'], 'slate': ['#64748b', '#94a3b8'],
            'olive': ['#84cc16', '#d9f99d'], 'stone': ['#57534e', '#a8a29e'], 'gold': ['#fbbf24', '#fde047'],
            'lightblue': ['#2563eb', '#93c5fd'], 'darkgreen': ['#065f46', '#10b981'], 'maroon': ['#881337', '#be123c'],
            'silver': ['#94a3b8', '#e2e8f0']
        };

        let PADS = {}; 
        let PAD_KEYS = {}; 

        // DOM elements
        const startWrapper = document.getElementById('start-wrapper');
        const nameScreen = document.getElementById('name-screen');
        const difficultyScreen = document.getElementById('difficulty-screen');
        const gameContainer = document.getElementById('game-container');
        
        const firebaseStatusBox = document.getElementById('firebase-status-box');
        const playerNameInput = document.getElementById('player-name-input');
        const currentPlayerNameDisplay = document.getElementById('current-player-name');
        const continueButton = document.getElementById('continue-button');
        const changeNameButton = document.getElementById('change-name-button');
        
        const difficultySelect = document.getElementById('difficulty-select'); 
        const playButton = document.getElementById('play-button');
        const leaderboardList = document.getElementById('leaderboard-list');

        const gameStartButton = document.getElementById('game-start-button');
        const backButton = document.getElementById('back-button');
        const statusDisplay = document.getElementById('status-display');
        const levelDisplay = document.getElementById('level-display');
        const highScoreDisplay = document.getElementById('high-score-display');
        const gameGrid = document.getElementById('game-grid');

        const gameOverModal = document.getElementById('game-over-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalScore = document.getElementById('modal-score');
        const modalNewRecord = document.getElementById('modal-new-record');
        const modalDifficultyName = document.getElementById('modal-difficulty-name');
        const modalLeaderboardList = document.getElementById('modal-leaderboard-list');
        const retryButton = document.getElementById('retry-button');
        const menuButton = document.getElementById('menu-button');

        // Game state variables
        let gameSequence = [];
        let playerSequence = [];
        let level = 1;
        let isPlayerTurn = false;
        let gameRunning = false;
        let currentDifficultyKey = 'hard'; 
        let currentDifficulty = DIFFICULTIES[currentDifficultyKey];
        let gameSpeed = 0; 
        
        // --- QU·∫¢N L√ù M√ÄN H√åNH ---
        function showScreen(screenId) {
            [nameScreen, difficultyScreen, gameContainer].forEach(s => s.classList.remove('active', 'hidden'));
            
            if (screenId === 'name-screen') {
                startWrapper.classList.remove('hidden');
                gameContainer.classList.add('hidden');
                nameScreen.classList.add('active');
                difficultyScreen.classList.add('hidden');
            } else if (screenId === 'difficulty-screen') {
                startWrapper.classList.remove('hidden');
                gameContainer.classList.add('hidden');
                nameScreen.classList.add('hidden');
                difficultyScreen.classList.add('active');
            } else if (screenId === 'game-container') {
                startWrapper.classList.add('hidden');
                gameContainer.classList.add('active');
            }
        }
        
        // --- FIREBASE & AUTH SETUP (ƒê√£ s·ª≠a) ---

        function updateFirebaseStatus(message, isError = false) {
            if (!firebaseStatusBox) return;
            firebaseStatusBox.textContent = `Tr·∫°ng th√°i Firebase: ${message}`;
            if (isError) {
                firebaseStatusBox.className = 'p-3 mb-6 rounded-lg text-sm font-medium bg-red-900 text-red-300 border border-red-700';
            } else {
                firebaseStatusBox.className = 'p-3 mb-6 rounded-lg text-sm font-medium bg-green-900 text-green-300 border border-green-700';
            }
        }
        
        function handleFirebaseError(error, step) {
            isFirebaseEnabled = false;
            console.error(`L·ªñI FIREBASE B∆Ø·ªöC ${step}:`, error);
            
            let errorMessage = "L·ªói kh√¥ng x√°c ƒë·ªãnh.";
            if (error && error.message) {
                errorMessage = error.message.replace(/Firebase: /, '').trim();
            } else if (error) {
                 errorMessage = error.toString();
            }
            
            updateFirebaseStatus(`L·ªñI K·∫æT N·ªêI (${step}): ${errorMessage}`, true);
            currentPlayerNameDisplay.innerHTML = `<span class="text-red-400 font-bold">CH·∫æ ƒê·ªò ƒê·ªòC L·∫¨P (L·ªói k·∫øt n·ªëi)</span>`;
            leaderboardList.innerHTML = `<li class="text-center text-red-400 py-4 font-bold">B·∫¢NG X·∫æP H·∫†NG T·∫ÆT: ${errorMessage}</li>`;
            
            // Cho ph√©p ch∆°i ·ªü ch·∫ø ƒë·ªô ƒë·ªôc l·∫≠p
            validatePlayerName(); 
        }

        async function setupFirebase() {
            updateFirebaseStatus("ƒêang kh·ªüi t·∫°o v·ªõi c·∫•u h√¨nh t√πy ch·ªânh...");

            // 1. Kh·ªüi t·∫°o App (S·ª≠ d·ª•ng config c·ªßa b·∫°n)
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug');
                isFirebaseEnabled = true;
                updateFirebaseStatus("Kh·ªüi t·∫°o App & Firestore th√†nh c√¥ng. ƒêang x√°c th·ª±c...");
            } catch (error) {
                handleFirebaseError(error, "Kh·ªüi t·∫°o App");
                return;
            }
            
            // 2. Ti·∫øn h√†nh X√°c th·ª±c (S·ª≠ d·ª•ng ƒëƒÉng nh·∫≠p ·∫©n danh v√¨ initialAuthToken = null)
            try {
                if (initialAuthToken) {
                    // S·∫Ω kh√¥ng ch·∫°y
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                handleFirebaseError(error, "X√°c th·ª±c (Auth)");
                return;
            }

            // 3. Thi·∫øt l·∫≠p l·∫Øng nghe tr·∫°ng th√°i x√°c th·ª±c
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentPlayerNameDisplay.textContent = `ID ng∆∞·ªùi ch∆°i (UID): ${userId}`;
                    
                    updateFirebaseStatus("K·∫øt n·ªëi Firebase HO√ÄN T·∫§T. ƒê√£ x√°c th·ª±c.");
                    await loadPlayerName(); // T·∫£i t√™n ƒë√£ l∆∞u
                    loadLeaderboard(difficultySelect.value); // T·∫£i leaderboard
                } else {
                    handleFirebaseError(new Error("Ng∆∞·ªùi d√πng kh√¥ng ƒë∆∞·ª£c x√°c th·ª±c."), "Tr·∫°ng th√°i Auth");
                }
            });
        }
        
        // --- PLAYER NAME LOGIC ---
        
        function validatePlayerName() {
            const currentName = playerNameInput.value.trim();
            const isValid = currentName.length >= 2 && currentName.length <= 15; 
            
            if (isValid) {
                continueButton.disabled = false;
                continueButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                continueButton.disabled = true;
                continueButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            return isValid;
        }

        const getPlayerProfileRef = () => {
            if (!userId || !db) return null;
            // L∆∞u d·ªØ li·ªáu ri√™ng t∆∞: artifacts/{appId}/users/{userId}/profile/data
            // S·ª≠ d·ª•ng appId trong config c·ªßa b·∫°n
            return doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
        };

        async function loadPlayerName() {
            if (!isFirebaseEnabled) {
                playerName = localStorage.getItem('simonPlayerName') || `Guest-${Math.random().toString(36).substr(2, 4)}`;
                playerNameInput.value = playerName;
                validatePlayerName();
                return;
            }

            const profileRef = getPlayerProfileRef();
            if (!profileRef) return;
            
            try {
                const docSnap = await getDoc(profileRef);
                if (docSnap.exists() && docSnap.data().name) {
                    playerName = docSnap.data().name;
                    playerNameInput.value = playerName;
                } else {
                    playerName = `Guest-${userId.substring(0, 4)}`;
                    playerNameInput.value = playerName;
                }
            } catch (e) {
                console.error("L·ªói khi t·∫£i t√™n:", e);
                playerName = `Guest-${userId.substring(0, 4)}`;
            }
            validatePlayerName();
        }

        async function savePlayerName() {
            if (!validatePlayerName()) return;
            
            playerName = playerNameInput.value.trim();

            if (!isFirebaseEnabled || !auth.currentUser) {
                localStorage.setItem('simonPlayerName', playerName);
                console.warn("Ch·∫ø ƒë·ªô ƒê·ªôc l·∫≠p: T√™n ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o localStorage.");
                showScreen('difficulty-screen');
                return;
            }

            const profileRef = getPlayerProfileRef();

            try {
                continueButton.disabled = true;
                continueButton.textContent = "ƒêANG L∆ØU...";
                await setDoc(profileRef, { name: playerName, userId: userId }, { merge: true });
                showScreen('difficulty-screen');
            } catch (e) {
                console.error("L·ªói khi l∆∞u t√™n:", e);
                alertUser("L·ªói khi l∆∞u t√™n. Vui l√≤ng th·ª≠ l·∫°i.");
            } finally {
                continueButton.disabled = false;
                continueButton.textContent = "L∆ØU T√äN & TI·∫æP T·ª§C";
            }
        }
        
        // --- GAME LOGIC ---

        function updateHighScoreDisplay() {
            const best = personalBestScores[currentDifficultyKey] || 0;
            highScoreDisplay.textContent = `ƒêi·ªÉm cao c√° nh√¢n: ${best}`;
        }
        
        async function saveScoreToLeaderboard(finalScore, difficultyKey) {
            // Lu√¥n c·∫≠p nh·∫≠t ƒëi·ªÉm cao c√° nh√¢n (bi·∫øn t·∫°m)
            const currentBest = personalBestScores[difficultyKey] || 0;
            let isNewRecord = false;
            if (finalScore > currentBest) {
                personalBestScores[difficultyKey] = finalScore;
                isNewRecord = true;
            }

            if (!isFirebaseEnabled || !userId || !db) {
                console.warn("Ch·∫ø ƒë·ªô ƒê·ªôc l·∫≠p: Kh√¥ng th·ªÉ l∆∞u ƒëi·ªÉm v√†o Leaderboard.");
                return isNewRecord; // Tr·∫£ v·ªÅ n·∫øu l√† k·ª∑ l·ª•c m·ªõi (offline)
            }
            
            const currentName = playerName;
            const leaderboardId = `${userId}_${difficultyKey}`;
            // L∆∞u d·ªØ li·ªáu c√¥ng c·ªông: artifacts/{appId}/public/data/leaderboard/{documentId}
            const scoreRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, leaderboardId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const currentScoreDoc = await transaction.get(scoreRef);
                    const existingScore = currentScoreDoc.exists() ? currentScoreDoc.data().score : 0;

                    if (finalScore > existingScore) {
                        transaction.set(scoreRef, {
                            userId: userId,
                            name: currentName,
                            score: finalScore,
                            difficulty: difficultyKey,
                            timestamp: Date.now() 
                        });
                    }
                });
            } catch (e) {
                console.error("L·ªói khi l∆∞u ƒëi·ªÉm v√†o Leaderboard:", e);
            }
            return isNewRecord;
        }

        function renderLeaderboard(scores, targetListElement) {
            targetListElement.innerHTML = '';

            if (scores.length === 0) {
                targetListElement.innerHTML = `<li class="text-center text-gray-400 py-2">Ch∆∞a c√≥ ƒëi·ªÉm n√†o cho c·∫•p ƒë·ªô n√†y.</li>`;
                return;
            }

            scores.forEach((data, index) => {
                const isCurrentUser = data.userId === userId; 
                const highlightClass = isCurrentUser ? 'bg-indigo-600/70 font-bold border-l-4 border-yellow-400' : 'hover:bg-gray-700/50';
                
                const listItem = document.createElement('li');
                listItem.className = `flex justify-between p-2 rounded-lg ${highlightClass} transition duration-150`;
                listItem.innerHTML = `
                    <span class="w-1/6 text-left">${index + 1}.</span>
                    <span class="w-3/6 text-left truncate">${data.name}</span>
                    <span class="w-2/6 text-right text-yellow-300">${data.score}</span>
                `;
                targetListElement.appendChild(listItem);
            });
        }

        // --- LEADERBOARD LISTENER (REAL-TIME) ---

        let unsubscribeLeaderboard = null;
        let currentLeaderboardData = []; // Cache d·ªØ li·ªáu leaderboard

        function loadLeaderboard(difficultyKey) {
            if (!isFirebaseEnabled || !db) {
                leaderboardList.innerHTML = `<li class="text-center text-red-400 py-4 font-bold">B·∫¢NG X·∫æP H·∫†NG T·∫ÆT (ƒê·ªôc l·∫≠p).</li>`;
                return;
            }

            if (unsubscribeLeaderboard) {
                unsubscribeLeaderboard();
            }

            leaderboardList.innerHTML = `<li class="text-center text-gray-400 py-4">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</li>`;

            // FIX: Removed orderBy and limit from the query to avoid the index error.
            const leaderboardQuery = query(
                collection(db, `artifacts/${appId}/public/data/leaderboard`),
                where('difficulty', '==', difficultyKey)
                // Sorting and limiting will be done in JavaScript.
            );

            unsubscribeLeaderboard = onSnapshot(leaderboardQuery, (snapshot) => {
                const allScores = []; // T·∫£i t·∫•t c·∫£ ƒëi·ªÉm cho ƒë·ªô kh√≥ n√†y
                let personalBest = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allScores.push(data);
                    
                    if (data.userId === userId) {
                         personalBest = Math.max(personalBest, data.score);
                    }
                });
                
                // NEW STEP 1: Sort scores locally by 'score' in descending order.
                allScores.sort((a, b) => b.score - a.score);
                
                // NEW STEP 2: Limit to top 10 after sorting.
                const topScores = allScores.slice(0, 10);
                
                currentLeaderboardData = topScores; // C·∫≠p nh·∫≠t cache
                personalBestScores[difficultyKey] = personalBest; // C·∫≠p nh·∫≠t ƒëi·ªÉm cao c√° nh√¢n
                updateHighScoreDisplay();
                renderLeaderboard(topScores, leaderboardList); // Render m√†n h√¨nh ch√≠nh

            }, (error) => {
                console.error("L·ªói khi t·∫£i Leaderboard (onSnapshot):", error);
                leaderboardList.innerHTML = `<li class="text-center text-red-400 py-4">L·ªói t·∫£i d·ªØ li·ªáu Leaderboard: Vui l√≤ng ki·ªÉm tra Console.</li>`;
            });
        }
        
        // --- UTILITY & GAME MECHANICS ---
        
        function alertUser(message, isGameStatus = false) {
            if(isGameStatus) {
                statusDisplay.textContent = message;
                return;
            }
            // Hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi tr√™n m√†n h√¨nh game
            const originalStatus = statusDisplay.textContent;
            statusDisplay.textContent = message;
            setTimeout(() => {
                 if (gameRunning) {
                     statusDisplay.textContent = originalStatus;
                 } else {
                     statusDisplay.textContent = 'Nh·∫•n B·∫ÆT ƒê·∫¶U';
                 }
            }, 2000);
        }

        async function flashPad(key) {
            const pad = PADS[key];
            if (!pad) return; 
            
            const originalColor = ALL_COLORS[key][0];
            const litColor = ALL_COLORS[key][1];

            pad.classList.add('lit');
            pad.style.backgroundColor = litColor; 
            
            await new Promise(resolve => setTimeout(resolve, gameSpeed * 0.7));

            pad.classList.remove('lit');
            pad.style.backgroundColor = originalColor; 
        }

        function setupGameBoard(difficultyKey) {
            gameGrid.innerHTML = ''; 
            currentDifficulty = DIFFICULTIES[difficultyKey];
            currentDifficultyKey = difficultyKey;
            PADS = {};
            PAD_KEYS = [];

            const colorKeys = Object.keys(ALL_COLORS);
            const selectedKeys = colorKeys.slice(0, currentDifficulty.colors);
            PAD_KEYS = selectedKeys;
            
            gameGrid.style.setProperty('--grid-size', currentDifficulty.root);
            
            selectedKeys.forEach(key => {
                const pad = document.createElement('div');
                pad.id = `${key}-pad`;
                pad.className = 'pad';
                pad.dataset.key = key;
                pad.style.backgroundColor = ALL_COLORS[key][0];
                pad.addEventListener('click', () => handlePlayerClick(key));
                PADS[key] = pad;
                gameGrid.appendChild(pad);
            });
            
            updateHighScoreDisplay(); // C·∫≠p nh·∫≠t ƒëi·ªÉm cao cho ƒë·ªô kh√≥ n√†y
        }


        function initializeGame() {
            gameSequence = [];
            playerSequence = [];
            level = 1;
            gameSpeed = currentDifficulty.speed; 
            isPlayerTurn = false;
            gameRunning = true;
            levelDisplay.textContent = `C·∫•p ƒë·ªô: ${level}`; 
            statusDisplay.textContent = 'M√°y ƒëang t·∫°o tr√¨nh t·ª±...';
            gameStartButton.textContent = 'ƒêANG CH∆†I...'; 
            gameStartButton.disabled = true; 
            gameStartButton.classList.add('opacity-50');
            backButton.disabled = true; 
            backButton.classList.add('opacity-50');
            
            setTimeout(nextRound, 1000);
        }

        function nextRound() {
            playerSequence = [];
            isPlayerTurn = false;
            levelDisplay.textContent = `C·∫•p ƒë·ªô: ${level}`;
            statusDisplay.textContent = 'M√°y ƒëang t·∫°o tr√¨nh t·ª±...';
            
            // TƒÉng t·ªëc ƒë·ªô
            if (level > 1 && level % 4 === 0) {
                gameSpeed = Math.max(80, gameSpeed * 0.9); 
            }

            const randomPad = PAD_KEYS[Math.floor(Math.random() * PAD_KEYS.length)];
            gameSequence.push(randomPad);

            playSequence();
        }

        async function playSequence() {
            gameGrid.classList.add('no-click');
            const pauseTime = Math.max(50, gameSpeed * 0.4); 

            await new Promise(resolve => setTimeout(resolve, 500)); // Ch·ªù 0.5s

            for (const padKey of gameSequence) {
                await flashPad(padKey);
                await new Promise(resolve => setTimeout(resolve, pauseTime));
            }

            gameGrid.classList.remove('no-click');
            isPlayerTurn = true;
            statusDisplay.textContent = `ƒê·∫øn l∆∞·ª£t b·∫°n! L·∫∑p l·∫°i ${gameSequence.length} b∆∞·ªõc.`;
        }

        function handlePlayerClick(key) {
            if (!isPlayerTurn || !gameRunning) return;

            flashPad(key); 

            playerSequence.push(key);
            const index = playerSequence.length - 1;

            if (playerSequence[index] !== gameSequence[index]) {
                gameOver();
                return;
            }

            if (playerSequence.length === gameSequence.length) {
                isPlayerTurn = false;
                level++;
                statusDisplay.textContent = 'Ch√≠nh x√°c! Chu·∫©n b·ªã...';
                
                setTimeout(nextRound, 1500);
            }
        }

        async function gameOver() {
            gameRunning = false;
            isPlayerTurn = false;
            gameGrid.classList.add('no-click');
            
            // Hi·ªáu ·ª©ng thua
            Object.values(PADS).forEach(pad => {
                pad.style.backgroundColor = '#f87171'; 
                pad.classList.add('lit');
            });
            
            const finalScore = level - 1;
            statusDisplay.textContent = `GAME OVER! B·∫°n ƒë·∫°t c·∫•p ƒë·ªô ${finalScore}.`;
            
            // L∆∞u ƒëi·ªÉm (Online ho·∫∑c Offline) v√† ki·ªÉm tra k·ª∑ l·ª•c m·ªõi
            const isNewRecord = await saveScoreToLeaderboard(finalScore, currentDifficultyKey);
            
            // Hi·ªÉn th·ªã Modal Game Over
            modalTitle.textContent = "GAME OVER!";
            modalScore.innerHTML = `B·∫°n ƒë·∫°t ƒë∆∞·ª£c: <span class="text-yellow-400">C·∫•p ${finalScore}</span>`;
            modalDifficultyName.textContent = currentDifficulty.name;
            
            if (isNewRecord) {
                modalNewRecord.classList.remove('hidden');
            } else {
                modalNewRecord.classList.add('hidden');
            }
            
            // Hi·ªÉn th·ªã leaderboard trong modal (t·ª´ d·ªØ li·ªáu cache)
            renderLeaderboard(currentLeaderboardData, modalLeaderboardList);

            // Ch·ªù 1s r·ªìi hi·ªÉn th·ªã modal
            setTimeout(() => {
                gameOverModal.classList.add('active');
            }, 1000);
        }
        
        function resetGame(startNew = false) {
             // ·∫®n modal
            gameOverModal.classList.remove('active');
            
            // Reset m√†u pad
            Object.values(PADS).forEach(pad => {
                pad.classList.remove('lit');
                pad.style.backgroundColor = ALL_COLORS[pad.dataset.key][0];
            });
            
            gameGrid.classList.remove('no-click');
            statusDisplay.textContent = 'Nh·∫•n B·∫ÆT ƒê·∫¶U';
            levelDisplay.textContent = 'C·∫•p ƒë·ªô: 1';
            gameStartButton.textContent = 'B·∫ÆT ƒê·∫¶U';
            gameStartButton.disabled = false;
            gameStartButton.classList.remove('opacity-50');
            backButton.disabled = false;
            backButton.classList.remove('opacity-50');

            if (startNew) {
                initializeGame();
            }
        }

        // --- EVENT LISTENERS ---
        
        // M√†n h√¨nh 1
        playerNameInput.addEventListener('input', validatePlayerName); 
        continueButton.addEventListener('click', savePlayerName);
        
        // M√†n h√¨nh 2
        changeNameButton.addEventListener('click', () => showScreen('name-screen'));
        playButton.addEventListener('click', () => {
            currentDifficultyKey = difficultySelect.value;
            setupGameBoard(currentDifficultyKey);
            showScreen('game-container');
            statusDisplay.textContent = 'Nh·∫•n B·∫ÆT ƒê·∫¶U';
        });
        difficultySelect.addEventListener('change', (e) => {
            currentDifficultyKey = e.target.value;
            if (isFirebaseEnabled) {
                loadLeaderboard(currentDifficultyKey); 
            }
        }); 
        
        // M√†n h√¨nh 3 (Game)
        gameStartButton.addEventListener('click', initializeGame);
        backButton.addEventListener('click', () => {
            gameRunning = false;
            gameSequence = [];
            playerSequence = [];
            showScreen('difficulty-screen');
            // T·∫£i l·∫°i Leaderboard khi quay v·ªÅ
            if (isFirebaseEnabled) {
                loadLeaderboard(difficultySelect.value); 
            }
        });

        // Modal Game Over
        retryButton.addEventListener('click', () => resetGame(true)); // Ch∆°i l·∫°i ngay
        menuButton.addEventListener('click', () => {
            resetGame(false); // Ch·ªâ reset tr·∫°ng th√°i
            showScreen('difficulty-screen'); // Quay v·ªÅ menu
            if (isFirebaseEnabled) {
                loadLeaderboard(difficultySelect.value); // T·∫£i l·∫°i leaderboard
            }
        });

        // --- KH·ªûI T·∫†O ---
        showScreen('name-screen'); // B·∫Øt ƒë·∫ßu ·ªü m√†n h√¨nh nh·∫≠p t√™n
        setupFirebase(); 
    </script>
</body>
</html>
